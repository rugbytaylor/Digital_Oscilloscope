name: ESP32 Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install ESP-IDF
      run: |
        git clone --recursive https://github.com/espressif/esp-idf.git
        cd esp-idf
        ./install.sh esp32
        . ./export.sh
        cd ..

    - name: Check code formatting
      run: |
        sudo apt-get install -y clang-format
        clang-format --version
        FORMAT_DIFF=$(clang-format -style=file -Werror --dry-run $(find main -name "*.c" -o -name "*.h") 2>&1)
        if [ -n "$FORMAT_DIFF" ]; then
          echo "Code formatting issues detected:"
          echo "$FORMAT_DIFF"
          exit 1
        fi

    - name: Generate version header
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        sed "s/\${BUILD_NUMBER}/${BUILD_NUMBER}/" main/version.h.template > main/version.h

    - name: Build Firmware
      run: |
        . esp-idf/export.sh
        idf.py fullclean
        idf.py build

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: |
          build/*.bin
          build/flasher_args.json

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Download firmware artifact
      uses: actions/download-artifact@v4
      with:
        name: firmware
        path: ./firmware

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v0.1.${{ github.run_number }}
        name: "Build ${{ github.run_number }}"
        body: "Automated firmware build for commit ${{ github.sha }}"
        files: |
          firmware/*.bin
          firmware/flasher_args.json
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
