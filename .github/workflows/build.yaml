name: ESP32 Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install ESP-IDF
      run: |
        git clone --recursive --branch release/v6.0 https://github.com/espressif/esp-idf.git
        cd esp-idf
        ./install.sh esp32
        . ./export.sh
        cd ..

    - name: Check code formatting using clang-format
      run: |
        sudo apt-get install -y clang-format
        FILES=$(find main -type f \( -name "*.c" -o -name "*.h" \))
        echo "formatting the following files:"
        echo "$FILES"
        clang-format -style=file -i $FILES


    - name: Generate version header
      run: |
        BUILD_NUM=${{ github.run_number }}
        sed "s/FW_BUILD 0/FW_BUILD ${BUILD_NUM}/" main/version.h.template > main/version.h

    - name: Build Firmware
      run: |
        . esp-idf/export.sh
        idf.py set-target esp32
        idf.py fullclean
        idf.py build

    - name: Upload build logs on failure
      if: failure()
      run: |
        mkdir -p build_logs
        cp -r build/log/* build_logs/ 2>/dev/null || true

    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build_logs
        path: build_logs/


    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: |
          build/*.bin
          build/flasher_args.json

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Download firmware artifact
      uses: actions/download-artifact@v4
      with:
        name: firmware
        path: ./firmware

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v0.1.${{ github.run_number }}
        name: "Build ${{ github.run_number }}"
        body: "Automated firmware build for commit ${{ github.sha }}"
        files: |
          firmware/*.bin
          firmware/flasher_args.json
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
