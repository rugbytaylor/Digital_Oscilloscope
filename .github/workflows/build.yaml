name: Digital Oscilloscope Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # ------------- CACHE ESP-IDF TOOLCHAIN -------------
    - name: Cache ESP-IDF Tools
      uses: actions/cache@v3
      id: espidf-tools-cache
      with:
        path: ~/.espressif
        key: ${{ runner.os }}-espidf-tools-${{ hashFiles('**/*.c', '**/*.h') }}

    # ------------- CACHE ESP-IDF DIRECTORY -------------
    - name: Cache ESP-IDF Source
      uses: actions/cache@v3
      id: espidf-cache
      with:
        path: esp-idf
        key: ${{ runner.os }}-espidf-${{ hashFiles('.github/workflows/build.yaml') }}

    # ------------- INSTALL ESP-IDF IF CACHE MISSED -------------
    - name: Install ESP-IDF
      if: steps.espidf-cache.outputs.cache-hit != 'true'
      run: |
        git clone --recursive --branch release/v6.0 https://github.com/espressif/esp-idf.git
        cd esp-idf
        ./install.sh esp32

    # Always export environment
    - name: Export ESP-IDF
      run: |
        cd esp-idf
        . ./export.sh
        cd ..

    - name: Install ESP-IDF Python Env
      run: |
        cd esp-idf
        ./install.sh esp32
        cd ..

    # ------------- FORMAT CODE -------------
    - name: Check code formatting using clang-format
      run: |
        sudo apt-get install -y clang-format
        FILES=$(find main -type f \( -name "*.c" -o -name "*.h" \))
        clang-format -style=file -i $FILES

    # ------------- AUTOMATED VERSIONING -------------
    - name: Generate version header
      run: |
        BUILD_NUM=${{ github.run_number }}
        sed "s/BUILD_NUM/${BUILD_NUM}/" main/version.h.template > main/version.h

    # ------------- BUILD -------------
    - name: Build Firmware
      run: |
        . esp-idf/export.sh
        idf.py set-target esp32
        idf.py build

    # ------------- LOG STORAGE ON FAIL -------------
    - name: Upload build logs on failure
      if: failure()
      run: |
        mkdir -p build_logs
        cp -r build/log/* build_logs/ 2>/dev/null || true

    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build_logs
        path: build_logs/

    - name: debug version file
      run: cat main/version.h

    # ------------- ARTIFACTS -------------
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: |
          build/*.bin
          build/flasher_args.json

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Download firmware artifact
      uses: actions/download-artifact@v4
      with:
        name: firmware
        path: ./firmware

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v0.1.${{ github.run_number }}
        name: "Build ${{ github.run_number }}"
        body: "Automated firmware build for commit ${{ github.sha }}"
        files: |
          firmware/*.bin
          firmware/flasher_args.json
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
